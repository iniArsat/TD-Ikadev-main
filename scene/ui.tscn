[gd_scene load_steps=4 format=3 uid="uid://b1rip3t5qrrds"]

[ext_resource type="PackedScene" uid="uid://dg51co7y2svjl" path="res://scene/tower_panel.tscn" id="1_onfsl"]
[ext_resource type="PackedScene" uid="uid://dvcxjo0exr078" path="res://scene/tower_panel2.tscn" id="2_kee8w"]

[sub_resource type="GDScript" id="GDScript_s2f8l"]
script/source = "extends Panel

@onready var tower_scene = preload(\"res://scene/tower_2.tscn\")
@onready var tidak_cukup: Label = $TidakCukup

var temp_tower = null
var is_dragging = false
var tower_cost = 50.0

func _on_gui_input(event: InputEvent) -> void:
	if event is InputEventMouseButton:
		# Saat klik kiri ditekan
		if event.button_index == MOUSE_BUTTON_LEFT and event.pressed:
			if GameManager.coin >= tower_cost:
				temp_tower = tower_scene.instantiate()
				add_child(temp_tower)
				temp_tower.process_mode = Node.PROCESS_MODE_DISABLED
				if temp_tower.has_method(\"start_drag\"):
					temp_tower.start_drag()
				is_dragging = true
			else:
				print(\"Koin tidak cukup untuk membeli tower!\")
				show_not_enough_coin_label()
		
		# Saat klik kiri dilepas
		elif event.button_index == MOUSE_BUTTON_LEFT and not event.pressed:
			if temp_tower:
				print(\"Tower dilepas\")
				if is_valid_drop_position(temp_tower.global_position):
					# Kurangi koin
					GameManager.coin -= tower_cost
					GameManager.emit_signal(\"update_coin\", GameManager.coin)
					
					# Aktifkan tower setelah dilepas
					temp_tower.process_mode = Node.PROCESS_MODE_INHERIT
					if temp_tower.has_method(\"stop_drag\"):
						temp_tower.stop_drag()
					print(\"Tower berhasil dipasang!\")
				else:
					print(\"Drop di area tidak valid â†’ tower dihapus\")
					temp_tower.queue_free()
				temp_tower = null
			is_dragging = false
	
	# Update posisi tower selama mouse bergerak
	elif event is InputEventMouseMotion and is_dragging and temp_tower:
		temp_tower.global_position = event.global_position

func is_valid_drop_position(pos: Vector2) -> bool:
	for area in GameManager.valid_drop_areas:
		if area is Area2D:
			var shape = area.get_node_or_null(\"CollisionShape2D\")
			if shape and shape.shape:
				var local_pos = area.to_local(pos)
				if shape.shape is RectangleShape2D and abs(local_pos.x) <= shape.shape.extents.x and abs(local_pos.y) <= shape.shape.extents.y:
					return true
	return false
func show_not_enough_coin_label():
	tidak_cukup.visible = true
	tidak_cukup.modulate.a = 1.0  # pastikan opacity penuh
	# Bikin label hilang otomatis setelah 1.5 detik
	var tween = create_tween()
	tween.tween_property(tidak_cukup, \"modulate:a\", 0.0, 1.5)
	await tween.finished
	tidak_cukup.visible = false
"

[node name="UI" type="CanvasLayer"]

[node name="Control" type="Control" parent="."]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Panel" type="Panel" parent="Control"]
layout_mode = 0
offset_left = 976.0
offset_top = 1.0
offset_right = 1154.0
offset_bottom = 648.0

[node name="TowerPanel" parent="Control" instance=ExtResource("1_onfsl")]
layout_mode = 0
offset_left = 982.0
offset_top = 1.0
offset_right = 1060.0
offset_bottom = 75.0

[node name="TowerPanel2" parent="Control" instance=ExtResource("2_kee8w")]
layout_mode = 0
offset_left = 1070.0
offset_top = 1.0
offset_right = 1148.0
offset_bottom = 75.0
script = SubResource("GDScript_s2f8l")
